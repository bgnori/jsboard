ajaxな(正確にはjsonpな)backgammon board manipuration API

concept:
sessionを使わずにcontextを持つ。
具体的にはgnubg idかxg idをかならず渡す。

i.e. 
move("jHPDAQXgPHgBWA:UQkyAQAAAAAA", "bar/21 24/20 8/4 8/4")
を渡すと

"jHPDAQXgPHgBWA:UQkyAQAAAAAA"がかえってくるなど


a) clickable map(http://w3g.jp/xhtml/dic/map)でeventを発生させる機能を作るためのAPI
b) ゲームのアクションを実装する上で必要な機能を提供するAPI
c) positionを編集する上で必要な機能を提供するAPI


留意:
1) データベースサービスをしたいならこれとは別にデータベースサーバを作る必要がある。
2) ゲームサービスをしたいならこれとは別にゲームサーバを作る必要がある。
- 待合室
- 対戦室


a) clickable map(http://w3g.jp/xhtml/dic/map)でeventを発生させる機能を作るためのAPI
画像とそれの上での各point/checkquer/cubeの座標が必要

<img src="イメージファイルのURI" alt="代替テキスト"
usemap="#マップ名称" width="横幅" height="高さ">
<map name="マップ名称">
<area shape="rect" coords="20,20,60,70"
href="リンク先のURI" alt="代替テキスト">
<area shape="circle" coords="90,30,20"
href="リンク先のURI" alt="代替テキスト">
<area shape="poly" coords="120,30,140,80,160,30,140,40"
href="リンク先のURI" alt="代替テキスト">
</map>
とかになる。
なので、jsでcoordsとurlを生成してあげないといけない。
またユーザの入力後はこの部分全てがさしかわる。

downとupを拾うようにするとdragできるように作ることができる。
moveのための文字列を生成するのはjsの仕事。基本的にはfrom/toの
文字をcatすればよいはず。
右クリックはすきなようにすればいい。


scriptaculousでのdrag
http://gihyo.jp/dev/feature/01/scriptaculous/0012?page=1

なんとなく掴めた。
-> sample/main.html

mapもしくはmapをいれたいdiv要素に対して関数を呼ぶ形式にする。
DOMで書き換えてmapを用意する。

- htmlを送りつける
- jsonpを送りつける


API仮決
High Level
 width, height, css, format, debug
 name..はたぶん不要。globalで同じ名前はあってもいいが、map下でuniqueならよいはず。
 namespace問題

static
backgammonbase.jsboard.positionviewer() // positionの表示
backgammonbase.jsboard.gameviewer() // gameを鑑賞

dynamic
backgammonbase.jsboard.editor() // positionの作成
backgammonbase.jsboard.player() // gameをプレー
backgammonbase.jsboard.explorer() // databaseを使うためのツール。

Low Level

orientation API... sends back coords of items on board
http://image.backgammonbase.com/image?gnubgid=4PPgAQPgc%2BQBIg%3AcAl7AAAAAAAA&height=262&width=341&css=nature&format=jsonp


jQuery
appendはthisを返す。

mat形式のfileの中身を貼り付けるとviewerが動くようにする。


defaultのsizeをどうするのか？
できればサーバと通信して決めるのがよいが、常識的に考えて400x300とかだろう。

とりあえずdivをムーブごとに生成できるようにした。
To Do:
ムーブごとにデータを付けてhover時に絵を差し替える。

Parts化する. (とりあえず、position viewerはここまで)

次はmatのparseか



今日はテストの整理。
mockサーバづくり

jsonp hello world with jQueryができた。 
決めなければいけないこと:
- 標準ではcallbackになっているパラメータ名を決める。 //事実上の関数呼び出し名。...mangleしてくれるライブラリが欲しくなる病
- 引数を決める。
- エラー処理について決める。

仕様に沿ったmock（一部のパラメータのみに正しく反応するサーバ)を用意する。


cssからレイアウトをいじるようにした。AreaMapはまたあとであたえられたエリアから
マップを生成する作業が必要。

次はサーバ作り。

bglibに該当機能が無かったっけ？
bglib.guiかたどるか？
bglib.modelのMoveFactoryあたり？

PartialMoveをMoveFactoryにくわせればよい(append)？
  def move_test(self):を見る限り、そのようだ。
    mf = MoveFactory(b)
としてboardからMoveFactoryをつくり、
PartialMoveを作って食わせればいい。


とりあえずは動いたが・・・。
encodeされて帰ってくるidが短い。

-> encoderがバグっている。

got: ZwAAwGwAAAAAAA:cIkkAAAAAAAA 3/off 1/off 
ZwAAwGwAAAAAAA cIkkAAAAAAAA
3/off
1/off

Traceback (most recent call last):
  File "/usr/lib/python2.4/site-packages/wsgiref/handlers.py", line 92, in run
    self.result = application(self.environ, self.start_response)
  File "server.py", line 63, in my_app
    assert len(p) == 14
AssertionError
shinano.tonic-water.com - - [10/Dec/2009 14:50:00] "GET /?callback=jsonp1260424200673&_=1260424200947&move=3%2Foff+1%2Foff+&gnubgid=ZwAAwGwAAAAAAA%3AcIkkAAAAAAAA HTTP/1.1" 500 59
got: ZwAAwGwAAAAAAA:cIkkAAAAAAAA 4/2 1/off(2) 
ZwAAwGwAAAAAAA cIkkAAAAAAAA
4/2
1/off(2)

Traceback (most recent call last):
  File "/usr/lib/python2.4/site-packages/wsgiref/handlers.py", line 92, in run
    self.result = application(self.environ, self.start_response)
  File "server.py", line 63, in my_app
    assert len(p) == 14
AssertionError
shinano.tonic-water.com - - [10/Dec/2009 14:50:00] "GET /?callback=jsonp1260424200674&_=1260424200952&move=4%2F2+1%2Foff(2)+&gnubgid=ZwAAwGwAAAAAAA%3AcIkkAAAAAAAA HTTP/1.1" 500 59

--> fixed.



moveがせいせいできていない。

got: sGfwgAPbuIEDIA:cIkqAAAAAAAA 24/22 13/9 
sGfwgAPbuIEDIA cIkqAAAAAAAA
24/22
13/9
Traceback (most recent call last):
  File "/usr/lib/python2.4/site-packages/wsgiref/handlers.py", line 92, in run
    self.result = application(self.environ, self.start_response)
  File "server.py", line 55, in my_app
    assert found
AssertionError
shinano.tonic-water.com - - [10/Dec/2009 14:50:00] "GET /?callback=jsonp1260424200641&_=1260424200692&move=24%2F22+13%2F9+&gnubgid=sGfwgAPbuIEDIA%3AcIkqAAAAAAAA HTTP/1.1" 500 59


got: sGfwgAPbuIEDIA:cIkqAAAAAAAA 8/4 6/4 
sGfwgAPbuIEDIA cIkqAAAAAAAA
8/4
Traceback (most recent call last):
  File "/usr/lib/python2.4/site-packages/wsgiref/handlers.py", line 92, in run
    self.result = application(self.environ, self.start_response)
  File "server.py", line 55, in my_app
    assert found
AssertionError
shinano.tonic-water.com - - [10/Dec/2009 14:50:00] "GET /?callback=jsonp1260424200642&_=1260424200704&move=8%2F4+6%2F4+&gnubgid=sGfwgAPbuIEDIA%3AcIkqAAAAAAAA HTTP/1.1" 500 59



got: mOfgASTYzsEAJg:cIkkAAAAAAAA 8/6 8/7(2) 
mOfgASTYzsEAJg cIkkAAAAAAAA
8/6
8/7(2)
Traceback (most recent call last):
  File "/usr/lib/python2.4/site-packages/wsgiref/handlers.py", line 92, in run
    self.result = application(self.environ, self.start_response)
  File "server.py", line 55, in my_app
    assert found
AssertionError
shinano.tonic-water.com - - [10/Dec/2009 14:50:00] "GET /?callback=jsonp1260424200669&_=1260424200918&move=8%2F6+8%2F7(2)+&gnubgid=mOfgASTYzsEAJg%3AcIkkAAAAAAAA HTTP/1.1" 500 59


addmoveしてしまうとdiceがすべて使われてしまう。
pmsが返すmoveをaddしたときにconsumeするdieが変？
再帰からもどったときに状態がrewindされていなかった。


ボードが白くかけてしまう現象
- 原因がよくわからない。
- キャッシュを消してreloadするとかわる。キャッシュもしくは画像生成系が原因だろう。
 firefox側が原因？

重傷では無いのでリリースする方向にいこう。


どうdeployするか？

いままで：
imageserverというuserを作って実行。

apacheのvhostで
- backgammonbase.com
- www.backgammonbase.comに
- image.backgammonbase.com
等に分配
/etc/httpd/conf.d/vhosts/backgammonbase.com

image.backgammonbase.comをport8001に飛ばしている。

memcacheしている
    <IfModule mod_cache.c>
        <IfModule mod_cache.c>
            CacheEnable mem /image
            MCacheSize 300000
#           KByte, 300MByte = 30KB x 10,000 entry
            MCacheMaxObjectCount 12323
            MCacheMaxObjectSize 30000
#           Byte
            MCacheRemovalAlgorithm LRU
        </IfModule>

port 8002をわりあてる？

wsgiをどうするか？
 a) wsgi ref
 b) CherryPy
 c) Django
 d) Pylons
 e) TurboGears
 f) apache mod_wsgi
 g) nginx + wsgi module
どれでもいいのだが、シンプルな奴がいい。

f)はセキュリティ上の理由から避けたい。
g)は興味深いが、httpdがふたつ載ることになる。

e)はすでにやったことがある。serviceがmonolithicになるのが気に入らない。
a)は大丈夫なの？

b), c), d)はわからないことが多い。

面倒だからTGにするか?もしくは気楽に作るa)か.
imageserverの名前が怪しくなるが、気にしないことにしよう。

TGのインスタンスはimageと共有するか？
リソースが無駄臭いが、入れ替えを考えると別にする
api.backgammonbase.com
move.api.backgammonbase.com
onroll.api.backgammonbase.com
edit.api.backgammonbase.com
をとりあえず用意。


package構成
- end user document
- api document
- js code
- server
- css

setup.pyを書く。

/var/www/backgammonbase.com

/var/www/backgammonbase.com/assets
 jsboard.js
 default.css


boardのstyleがpage単位でしか指定できない。

howtouse.txtを追加した。
yamakaze/umikazeでテストか。


